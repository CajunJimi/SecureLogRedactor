<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLog Redaction Tool</title>
    <script src="https://unpkg.com/compromise@14.10.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Basic reset and modern styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 2.5rem;
        }

        .security-info {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .redaction-controls {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .redaction-type {
            margin: 10px 0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .action-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .action-button:hover {
            background-color: #0056b3;
        }

        .action-button.secondary {
            background-color: #6c757d;
        }

        .action-button.secondary:hover {
            background-color: #545b62;
        }

        .action-button i {
            font-size: 0.9em;
        }

        .redact-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }

        .redact-button:hover {
            background-color: #218838;
        }

        .detected-items {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }

        .section {
            margin: 20px 0;
        }

        .section-header {
            background-color: #f6f8fa;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-header:hover {
            background-color: #f0f2f5;
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: white;
        }

        .section-content.expanded {
            max-height: 500px;
            overflow: auto;
        }

        .text-area-container {
            padding: 10px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .button-group {
            margin-top: 10px;
        }

        .button-group button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button-group button:hover {
            background-color: #2980b9;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .file-section {
            margin: 2rem 0;
            text-align: center;
        }

        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-label:hover, .file-label:focus {
            background-color: #2980b9;
        }

        .file-info {
            margin-top: 1rem;
            color: #666;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e74c3c;
            margin: 1rem 0;
            padding: 0.5rem;
            background-color: #fde8e8;
            border-radius: 4px;
            display: none;
        }

        .error-message.fade-in {
            animation: fadeIn 0.5s;
        }

        .error-message.fade-out {
            animation: fadeOut 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .redaction-mode {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .toggle-labels {
            display: flex;
            gap: 20px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .toolbar {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 5px 10px;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }

        .toolbar button:hover {
            background-color: #dee2e6;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-options {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }

        .export-options a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .export-options a:hover {
            background-color: #f1f1f1;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        .status-message.info {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1976d2;
        }

        .status-message.warning {
            background-color: #fff3e0;
            border: 1px solid #ffe0b2;
            color: #f57c00;
        }

        .status-message.error {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
        }

        .status-message.success {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            color: #2e7d32;
        }

        .sensitive-data {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
            border: 1px solid #ffeeba;
            position: relative;
        }
        .sensitive-data:hover::after {
            content: attr(data-type);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }

        .modal-body h3 {
            display: flex;
            align-items: center;
            margin: 20px 0 15px 0;
            color: #2c3e50;
        }

        .modal-body h3 i {
            margin-right: 10px;
            color: #007bff;
        }

        .modal-body ul {
            list-style: none;
            padding-left: 35px;
        }

        .modal-body li {
            margin: 10px 0;
            position: relative;
        }

        .modal-body li i {
            position: absolute;
            left: -25px;
            top: 3px;
            color: #28a745;
            font-size: 0.9em;
        }

        .modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
        }

        .modal h2 i {
            margin-right: 10px;
            color: #007bff;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        .info-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }

        .info-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SecureLog Redaction Tool</h1>
        <button class="info-button" onclick="openInfoModal()">How It Works</button>
        
        <!-- Status and Error Messages -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <div class="security-info">
            <h3>Security Information</h3>
            <p>This tool helps redact sensitive information from logs before processing. All processing is done locally in your browser.</p>
        </div>

        <!-- File Upload Section -->
        <div class="file-section">
            <label for="logFile" class="file-label" role="button" tabindex="0">
                Choose a log file to process
                <input type="file" id="logFile" accept=".log,.txt" aria-label="Choose a log file to process" style="display: none;">
            </label>
            <div id="fileInfo" class="file-info" aria-live="polite"></div>
            <div id="statusMessage" class="status-message" style="display: none;"></div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <div class="redaction-controls">
            <h3>Redaction Settings</h3>
            <div class="redaction-type">
                <label>
                    <input type="checkbox" id="redactIP" checked>
                    IP Addresses (IPv4 & IPv6)
                </label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactIpv4" checked>
                <label for="redactIpv4">IPv4 Addresses</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactIpv6" checked>
                <label for="redactIpv6">IPv6 Addresses</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactDomain" checked>
                <label for="redactDomain">Domain Names & Hostnames</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactSid" checked>
                <label for="redactSid">Security IDs (SIDs)</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactAccount" checked>
                <label for="redactAccount">Account Names</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactGuid" checked>
                <label for="redactGuid">GUIDs & Unique Identifiers</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactKerberos" checked>
                <label for="redactKerberos">Kerberos Tickets</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactMac" checked>
                <label for="redactMac">MAC Addresses</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactCloudCreds" checked>
                <label for="redactCloudCreds">Cloud Credentials</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactJwt" checked>
                <label for="redactJwt">JWT Tokens</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactBase64" checked>
                <label for="redactBase64">Base64 Encoded Data</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactEmail" checked>
                <label for="redactEmail">Email Addresses</label>
            </div>
            
            <div class="action-buttons">
                <button class="action-button" onclick="savePreferences()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                <button class="action-button secondary" onclick="resetPreferences()">
                    <i class="fas fa-undo"></i> Reset Defaults
                </button>
            </div>
        </div>

        <div class="redaction-mode">
            <h3>Redaction Mode</h3>
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="redactionMode">
                    <span class="slider round"></span>
                </label>
                <div class="toggle-labels">
                    <span>Redacted Text</span>
                    <span>Dummy Data</span>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button onclick="undoRedaction()" id="undoBtn" disabled>Undo</button>
            <button onclick="redoRedaction()" id="redoBtn" disabled>Redo</button>
            <button onclick="copySelected()">Copy Selected</button>
            <div class="export-dropdown">
                <button onclick="toggleExportOptions()">Export Results</button>
                <div class="export-options" id="exportOptions">
                    <a href="#" onclick="exportResults('json')">Export as JSON</a>
                    <a href="#" onclick="exportResults('csv')">Export as CSV</a>
                </div>
            </div>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>

        <div class="section">
            <div class="section-header" onclick="toggleSection('input')">
                <h2>Input Log Data</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content" id="input-section">
                <div class="text-area-container">
                    <textarea id="input-text" placeholder="Paste your log data here..."></textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header" onclick="toggleSection('output')">
                <h2>Processed Output</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content" id="output-section">
                <div class="detected-items" id="detected-sensitive-info">
                    <h4>Detected Sensitive Information:</h4>
                    <ul id="sensitive-items-list"></ul>
                </div>
                <div class="text-area-container">
                    <textarea id="output-text" readonly></textarea>
                    <div class="button-group">
                        <button onclick="downloadOutput()">Download Redacted Log</button>
                        <button onclick="copyToClipboard()">Copy to Clipboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Information Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeInfoModal()">&times;</span>
            <h2><i class="fas fa-shield-alt"></i>How SecureLog Redactor Works</h2>
            <div class="modal-body">
                <h3><i class="fas fa-lock"></i>Privacy & Security</h3>
                <ul>
                    <li><i class="fas fa-check-circle"></i><strong>100% Local Processing:</strong> All data processing occurs entirely in your browser. No data is ever sent to external servers.</li>
                    <li><i class="fas fa-check-circle"></i><strong>Zero Data Storage:</strong> We don't store any of your data. Once you close the browser tab, all data is cleared.</li>
                    <li><i class="fas fa-check-circle"></i><strong>Offline Capable:</strong> The tool works even without an internet connection after initial load.</li>
                </ul>
                
                <h3><i class="fas fa-cogs"></i>Technical Details</h3>
                <ul>
                    <li><i class="fas fa-check-circle"></i><strong>Browser-Based:</strong> Uses modern browser technologies for secure, local processing.</li>
                    <li><i class="fas fa-check-circle"></i><strong>Pattern Recognition:</strong> Advanced algorithms identify sensitive data patterns.</li>
                    <li><i class="fas fa-check-circle"></i><strong>Real-time Processing:</strong> Instant redaction as you type or upload files.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner" role="progressbar" aria-label="Processing file"></div>
        <p>Processing...</p>
    </div>

    <script>
        // Configuration constants
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            CHUNK_SIZE: 50000, // 50KB chunks
            ALLOWED_EXTENSIONS: ['.log', '.txt'],
            MAX_FILES_PER_MINUTE: 10,
            MAX_CONTENT_LENGTH: 50 * 1024 * 1024, // 50MB total
            MIME_TYPES: ['text/plain', 'application/log', 'text/x-log']
        };

        // Rate limiting
        const rateLimit = {
            count: 0,
            lastReset: Date.now(),
            
            check() {
                const now = Date.now();
                if (now - this.lastReset > 60000) { // 1 minute
                    this.count = 0;
                    this.lastReset = now;
                }
                if (this.count >= CONFIG.MAX_FILES_PER_MINUTE) {
                    throw new Error('Too many files processed. Please wait a minute.');
                }
                this.count++;
            },

            reset() {
                this.count = 0;
                this.lastReset = Date.now();
            }
        };

        // Memory management
        const memoryManager = {
            checkMemory() {
                if (performance && performance.memory) {
                    const usedHeap = performance.memory.usedJSHeapSize;
                    const heapLimit = performance.memory.jsHeapSizeLimit;
                    if (usedHeap > heapLimit * 0.8) {
                        throw new Error('Memory usage too high. Please try a smaller file.');
                    }
                }
            },

            estimateTextSize(text) {
                // Rough estimate: 2 bytes per character + overhead
                return text.length * 2;
            }
        };

        // Enhanced file validation
        async function validateFile(file) {
            if (!file) {
                throw new Error('Please select a file');
            }

            // Check rate limit
            rateLimit.check();

            // Size validation
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                throw new Error(`File size exceeds ${CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB limit`);
            }

            // Extension validation
            const extension = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            if (!CONFIG.ALLOWED_EXTENSIONS.includes(extension)) {
                throw new Error('Invalid file type. Please upload .log or .txt files only');
            }

            // MIME type validation
            if (!CONFIG.MIME_TYPES.includes(file.type) && file.type !== '') {
                throw new Error('Invalid file type. Please upload text files only');
            }

            // Content validation
            try {
                const firstChunk = await readFileChunk(file, 1024); // Read first 1KB
                if (!isValidTextContent(firstChunk)) {
                    throw new Error('File contains invalid or binary content');
                }
            } catch (error) {
                throw new Error('Error validating file content: ' + error.message);
            }

            // Memory check
            memoryManager.checkMemory();
        }

        // Helper function to read file chunk
        function readFileChunk(file, size) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const blob = file.slice(0, size);
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(blob);
            });
        }

        // Helper function to validate text content
        function isValidTextContent(text) {
            // Check for common binary file signatures
            const binarySignatures = [
                '\u0000', // Null byte
                '\uFFFF', // Unicode BOM
                '\u7F45', // ELF header
                '\u4D5A'  // DOS MZ header
            ];
            
            for (const signature of binarySignatures) {
                if (text.includes(signature)) {
                    return false;
                }
            }

            // Check if text is mostly printable characters
            const printableChars = text.replace(/[\x20-\x7E\n\r\t]/g, '');
            return printableChars.length / text.length < 0.1; // Allow 10% non-printable chars
        }

        // Error handling and status functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            if (!statusDiv) {
                console.warn('Status message element not found');
                return;
            }
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            console.log(`Status [${type}]:`, message);

            // Auto-hide after 5 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Enhanced error handling
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            if (!errorMessage) {
                console.error('Error message element not found');
                return;
            }
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.className = 'error-message fade-in';
            errorMessage.style.display = 'block';
            
            // Also log to console for debugging
            console.error('Error:', message);
            
            setTimeout(() => {
                errorMessage.className = 'error-message fade-out';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 500);
            }, 4500);
        }

        // File handling
        document.getElementById('logFile').addEventListener('change', async function(event) {
            try {
                const file = event.target.files[0];
                if (!file) {
                    throw new Error('No file selected');
                }
                showStatus('Processing file: ' + file.name);
                const fileInfo = document.getElementById('fileInfo');
                const loadingOverlay = document.getElementById('loadingOverlay');
                const errorMessage = document.getElementById('errorMessage');
                
                errorMessage.style.display = 'none';
                fileInfo.textContent = '';

                await validateFile(file);
                loadingOverlay.style.display = 'flex';
                fileInfo.textContent = `Processing ${file.name}...`;

                const reader = new FileReader();

                reader.onload = async function(e) {
                    try {
                        const log = e.target.result;
                        document.getElementById('input-text').value = log;
                        processText();
                        fileInfo.textContent = `Successfully processed ${file.name}`;
                        
                        // Expand the output section
                        document.getElementById('output-section').classList.add('expanded');
                    } catch (error) {
                        showError(error);
                    } finally {
                        loadingOverlay.style.display = 'none';
                    }
                };

                reader.onerror = function() {
                    showError('Error reading file');
                    loadingOverlay.style.display = 'none';
                };

                reader.readAsText(file);
            } catch (error) {
                showError(error);
            }
        });

        // Keyboard accessibility for file input label
        document.querySelector('.file-label').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });

        function toggleSection(sectionId) {
            const section = document.getElementById(`${sectionId}-section`);
            section.classList.toggle('expanded');
        }

        // Dummy data generators
        const dummyData = {
            // Enhanced IP generation with common ranges
            generateIP: () => {
                const ranges = [
                    '10.0.0',     // Private network
                    '172.16.0',   // Private network
                    '192.168.0',  // Private network
                    '203.0.113',  // Documentation
                    '198.51.100'  // Documentation
                ];
                const range = ranges[Math.floor(Math.random() * ranges.length)];
                return `${range}.${Math.floor(Math.random() * 256)}`;
            },

            // Enhanced IPv6 with common prefixes
            generateIPv6: () => {
                const prefixes = [
                    'fd00',  // Unique Local Address
                    'fe80',  // Link Local
                    '2001',  // Global Unicast
                    '2606'   // Documentation
                ];
                const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
                return `${prefix}:${Array.from({length: 7}, () => 
                    Math.floor(Math.random() * 65536).toString(16).padStart(4, '0')
                ).join(':')}`;
            },

            // Enhanced domain with realistic TLDs and subdomains
            generateDomain: () => {
                const tlds = ['com', 'net', 'org', 'local', 'internal', 'corp'];
                const companies = ['contoso', 'acme', 'example', 'test'];
                const services = ['web', 'mail', 'db', 'auth', 'api', 'app'];
                const regions = ['us', 'eu', 'asia'];
                const company = companies[Math.floor(Math.random() * companies.length)];
                const service = services[Math.floor(Math.random() * services.length)];
                const region = regions[Math.floor(Math.random() * regions.length)];
                const tld = tlds[Math.floor(Math.random() * tlds.length)];
                return `${service}-${region}.${company}.${tld}`;
            },

            // Enhanced paths with realistic directory structures
            generatePath: () => {
                const winPaths = [
                    'C:\\Windows\\System32\\config',
                    'C:\\Program Files\\Common Files',
                    'C:\\Users\\Administrator\\AppData',
                    'D:\\Logs\\Application',
                    'E:\\Backup\\System'
                ];
                const unixPaths = [
                    '/var/log/syslog',
                    '/etc/security',
                    '/usr/local/bin',
                    '/opt/application/logs',
                    '/home/user/.config'
                ];
                const paths = [...winPaths, ...unixPaths];
                const files = [
                    'Security.evtx',
                    'Application.log',
                    'access_log',
                    'error.log',
                    'auth.log',
                    'system.log'
                ];
                const path = paths[Math.floor(Math.random() * paths.length)];
                const file = files[Math.floor(Math.random() * files.length)];
                return path.includes('\\') ? `${path}\\${file}` : `${path}/${file}`;
            },

            // Enhanced SID with realistic structure
            generateSID: () => {
                const authorities = ['5', '12', '15', '21'];
                const domains = ['500', '501', '502', '512', '513', '519'];
                const users = ['1000', '1001', '1002', '1003', '1004'];
                return `S-1-${authorities[Math.floor(Math.random() * authorities.length)]}-21-${
                    Math.floor(Math.random() * 4294967296)}-${
                    Math.floor(Math.random() * 4294967296)}-${
                    Math.floor(Math.random() * 4294967296)}-${
                    domains[Math.floor(Math.random() * domains.length)]}-${
                    users[Math.floor(Math.random() * users.length)]}`;
            },

            // Enhanced GUID generation
            generateGUID: () => {
                const hex = () => Math.floor(Math.random() * 16).toString(16);
                const block = (len) => Array.from({length: len}, hex).join('');
                return `${block(8)}-${block(4)}-4${block(3)}-${
                    '89ab'[Math.floor(Math.random() * 4)]
                }${block(3)}-${block(12)}`;
            },

            // Enhanced Kerberos with realistic principals
            generateKerberos: () => {
                const services = ['HTTP', 'MSSQL', 'LDAP', 'HOST', 'CIFS', 'NFS'];
                const servers = ['DC01', 'APP01', 'WEB01', 'DB01', 'FILE01'];
                const realms = ['CORP.LOCAL', 'CONTOSO.COM', 'EXAMPLE.NET'];
                const service = services[Math.floor(Math.random() * services.length)];
                const server = servers[Math.floor(Math.random() * servers.length)];
                const realm = realms[Math.floor(Math.random() * realms.length)];
                return `${service}/${server}.${realm.toLowerCase()}@${realm}`;
            },

            // Enhanced MAC with common vendor prefixes
            generateMAC: () => {
                const vendors = [
                    '00:0C:29', // VMware
                    '00:50:56', // VMware
                    '00:1A:A0', // Dell
                    '00:16:3E', // Xen
                    'EC:F4:BB'  // Microsoft
                ];
                const vendor = vendors[Math.floor(Math.random() * vendors.length)];
                const device = Array.from({length: 3}, () => 
                    Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
                ).join(':');
                return `${vendor}:${device}`;
            },

            // Enhanced cloud credentials with realistic formats
            generateCloudCreds: () => {
                const types = {
                    'AWS': {
                        accessKey: 'AKIA' + Array.from({length: 16}, () => 
                            '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 36)]
                        ).join(''),
                        secretKey: Array.from({length: 40}, () => 
                            '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/'[Math.floor(Math.random() * 64)]
                        ).join('')
                    },
                    'Azure': {
                        appId: Array.from({length: 8}, () => Math.floor(Math.random() * 16).toString(16)).join('') + '-' +
                               Array.from({length: 4}, () => Math.floor(Math.random() * 16).toString(16)).join('') + '-' +
                               Array.from({length: 4}, () => Math.floor(Math.random() * 16).toString(16)).join('') + '-' +
                               Array.from({length: 4}, () => Math.floor(Math.random() * 16).toString(16)).join('') + '-' +
                               Array.from({length: 12}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                        secret: Array.from({length: 44}, () => 
                            '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_'[Math.floor(Math.random() * 64)]
                        ).join('')
                    },
                    'GCP': {
                        serviceAccount: `${Math.floor(Math.random() * 1000000)}@project-${
                            Math.floor(Math.random() * 100000)}.iam.gserviceaccount.com`,
                        key: 'ya29.' + Array.from({length: 100}, () => 
                            '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_'[Math.floor(Math.random() * 64)]
                        ).join('')
                    }
                };
                const provider = Object.keys(types)[Math.floor(Math.random() * Object.keys(types).length)];
                const creds = types[provider];
                switch(provider) {
                    case 'AWS':
                        return `AWS_ACCESS_KEY_ID=${creds.accessKey}\nAWS_SECRET_ACCESS_KEY=${creds.secretKey}`;
                    case 'Azure':
                        return `AZURE_CLIENT_ID=${creds.appId}\nAZURE_CLIENT_SECRET=${creds.secret}`;
                    case 'GCP':
                        return `GCP_SERVICE_ACCOUNT=${creds.serviceAccount}\nGCP_KEY=${creds.key}`;
                }
            },

            // Generate realistic log entries
            generateLogEntry: () => {
                const logTypes = [
                    'windowsEvent',
                    'syslog',
                    'apache',
                    'iis',
                    'auth'
                ];
                const type = logTypes[Math.floor(Math.random() * logTypes.length)];
                const timestamp = new Date().toISOString();
                const ip = dummyData.generateIP();
                const domain = dummyData.generateDomain();
                const user = `user${Math.floor(Math.random() * 1000)}`;
                
                switch(type) {
                    case 'windowsEvent':
                        return `<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{${dummyData.generateGUID()}'/><EventID>4624</EventID><Version>0</Version><Level>0</Level><Task>12544</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='${timestamp}'/><EventRecordID>${Math.floor(Math.random() * 1000000)}</EventRecordID><Correlation ActivityID='{${dummyData.generateGUID()}}'/><Execution ProcessID='${Math.floor(Math.random() * 1000)}' ThreadID='${Math.floor(Math.random() * 1000)}'/><Channel>Security</Channel><Computer>${domain}</Computer></System><EventData><Data Name='SubjectUserSid'>${dummyData.generateSID()}</Data><Data Name='SubjectUserName'>${user}</Data><Data Name='SubjectDomainName'>DOMAIN</Data><Data Name='SubjectLogonId'>0x${Math.floor(Math.random() * 1000000).toString(16)}</Data><Data Name='TargetUserSid'>${dummyData.generateSID()}</Data><Data Name='TargetUserName'>${user}</Data><Data Name='TargetDomainName'>DOMAIN</Data><Data Name='TargetLogonId'>0x${Math.floor(Math.random() * 1000000).toString(16)}</Data><Data Name='LogonType'>3</Data><Data Name='LogonProcessName'>Kerberos</Data><Data Name='AuthenticationPackageName'>Kerberos</Data><Data Name='WorkstationName'>${domain}</Data><Data Name='LogonGuid'>{${dummyData.generateGUID()}}</Data><Data Name='TransmittedServices'>-</Data><Data Name='LmPackageName'>-</Data><Data Name='KeyLength'>0</Data><Data Name='ProcessId'>0x${Math.floor(Math.random() * 1000000).toString(16)}</Data><Data Name='ProcessName'>-</Data><Data Name='IpAddress'>${ip}</Data><Data Name='IpPort'>${Math.floor(Math.random() * 65536)}</Data></EventData></Event>`;
                    
                    case 'syslog':
                        const facility = Math.floor(Math.random() * 23);
                        const severity = Math.floor(Math.random() * 7);
                        const pid = Math.floor(Math.random() * 100000);
                        return `<${facility * 8 + severity}>${timestamp} ${domain} ${user}[${pid}]: session opened for user ${user} by (uid=0)`;
                    
                    case 'apache':
                        const status = [200, 301, 302, 304, 400, 401, 403, 404, 500][Math.floor(Math.random() * 9)];
                        const size = Math.floor(Math.random() * 1000000);
                        const userAgent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36';
                        return `${ip} - ${user} [${timestamp}] "GET /api/v1/users HTTP/1.1" ${status} ${size} "https://${domain}/" "${userAgent}"`;
                    
                    case 'iis':
                        const method = ['GET', 'POST', 'PUT', 'DELETE'][Math.floor(Math.random() * 4)];
                        const uri = ['/api/v1/users', '/login', '/logout', '/dashboard'][Math.floor(Math.random() * 4)];
                        return `${timestamp} ${ip} ${method} ${uri} 443 ${user} ${domain} 80 200 0 0 ${Math.floor(Math.random() * 1000)} ${Math.floor(Math.random() * 1000)} "Mozilla/5.0+(Windows+NT+10.0;+Win64;+x64)"`;
                    
                    case 'auth':
                        const actions = ['Successful login', 'Failed login attempt', 'Password change', 'Account locked'];
                        const action = actions[Math.floor(Math.random() * actions.length)];
                        return `${timestamp} auth: ${action} for user ${user} from ${ip} on ${domain}`;
                }
            }
        };
        
        // Cache for compiled regex patterns
        const REGEX_PATTERNS = {
            ipv4: /\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,
            ipv6: /\b(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}\b|::1\b/gi,
            domain: /\b(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+(?:local|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/gi,
            sid: /\bS-1-[0-9-]+\b/g,
            guid: /\{?[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}\}?/gi,
            email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g
        };

        // Function to check if a string is a path
        function isPath(str) {
            return (
                str.includes(':\\') || // Windows path
                str.startsWith('/') || // Unix path
                str.startsWith('\\\\') || // Network share
                /\\[^\\\/\s]+/.test(str) // Path component
            );
        }

        // Undo/Redo stacks
        const undoStack = [];
        const redoStack = [];
        let currentText = '';

        // Load saved preferences
        function loadPreferences() {
            try {
                const savedPrefs = localStorage.getItem('redactionPreferences');
                if (savedPrefs) {
                    const prefs = JSON.parse(savedPrefs);
                    Object.entries(prefs).forEach(([id, checked]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.checked = checked;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        // Save preferences
        function savePreferences() {
            const prefs = {};
            document.querySelectorAll('.redaction-type input[type="checkbox"]').forEach(checkbox => {
                prefs[checkbox.id] = checkbox.checked;
            });
            localStorage.setItem('redactionPreferences', JSON.stringify(prefs));
        }

        // Initialize preferences
        loadPreferences();
        document.querySelectorAll('.redaction-type input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', savePreferences);
        });

        // Initialize redaction options
        const redactionTypes = {
            'Ipv4': true,
            'Ipv6': true,
            'Domain': true,
            'Sid': true,
            'Account': true,
            'Guid': true,
            'Kerberos': true,
            'Mac': true,
            'CloudCreds': true,
            'Jwt': true,
            'Base64': true,
            'Email': true
        };

        // Set initial checkbox states
        Object.keys(redactionTypes).forEach(type => {
            const checkbox = document.getElementById(`redact${type}`);
            if (checkbox) {
                checkbox.checked = redactionTypes[type];
            }
        });

        // Chunked processing
        async function processInChunks(text, chunkSize = 50000) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.slice(i, i + chunkSize));
            }

            const progressBar = document.getElementById('progressBar');
            const progressBarFill = document.getElementById('progressBarFill');
            progressBar.style.display = 'block';

            let processedText = '';
            for (let i = 0; i < chunks.length; i++) {
                const chunk = chunks[i];
                // Process chunk
                processedText += await processChunk(chunk);
                // Update progress
                const progress = ((i + 1) / chunks.length) * 100;
                progressBarFill.style.width = `${progress}%`;
                // Allow UI to update
                await new Promise(resolve => setTimeout(resolve, 0));
            }

            progressBar.style.display = 'none';
            return processedText;
        }

        async function processChunk(chunk) {
            const useDummyData = document.getElementById('redactionMode').checked;

            try {
                // Try to parse as JSON first
                const isJson = chunk.trim().startsWith('{') && chunk.trim().endsWith('}');
                if (isJson) {
                    const jsonObj = JSON.parse(chunk);
                    
                    // Process each field in the JSON object
                    const processJsonValue = (value) => {
                        if (typeof value === 'string') {
                            let processedValue = value;
                            let matches = [];
                            
                            // First collect all matches
                            Object.entries(REGEX_PATTERNS).forEach(([type, regex]) => {
                                const checkbox = document.getElementById(`redact${type.charAt(0).toUpperCase() + type.slice(1)}`);
                                if (checkbox && checkbox.checked) {
                                    const typeMatches = [...processedValue.matchAll(regex)].map(match => ({
                                        type,
                                        match: match[0],
                                        index: match.index,
                                        length: match[0].length
                                    }));
                                    matches.push(...typeMatches);
                                }
                            });

                            // Remove overlapping matches
                            matches = matches.filter((match, index) => {
                                for (let i = 0; i < matches.length; i++) {
                                    if (i !== index) {
                                        const other = matches[i];
                                        if (match.index < other.index + other.length && 
                                            other.index < match.index + match.length) {
                                            // Keep the longer match
                                            return match.length >= other.length;
                                        }
                                    }
                                }
                                return true;
                            });

                            // Sort matches by index in reverse order
                            matches.sort((a, b) => b.index - a.index);

                            // Apply replacements
                            matches.forEach(({type, match, index}) => {
                                const replacement = useDummyData ? 
                                    dummyData[`generate${type.charAt(0).toUpperCase() + type.slice(1)}`]() : 
                                    `[REDACTED-${type.toUpperCase()}]`;
                                processedValue = processedValue.slice(0, index) + replacement + processedValue.slice(index + match.length);
                            });

                            return processedValue;
                        } else if (Array.isArray(value)) {
                            return value.map(item => processJsonValue(item));
                        } else if (typeof value === 'object' && value !== null) {
                            const processed = {};
                            Object.entries(value).forEach(([k, v]) => {
                                processed[k] = processJsonValue(v);
                            });
                            return processed;
                        }
                        return value;
                    };

                    const processedJson = processJsonValue(jsonObj);
                    return JSON.stringify(processedJson, null, 2);
                }
            } catch (e) {
                console.log('Not valid JSON, processing as plain text:', e);
            }

            // Process as plain text if not JSON
            let processedChunk = chunk;
            let matches = [];
            
            // First collect all matches
            Object.entries(REGEX_PATTERNS).forEach(([type, regex]) => {
                const checkbox = document.getElementById(`redact${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (checkbox && checkbox.checked) {
                    const typeMatches = [...processedChunk.matchAll(regex)].map(match => ({
                        type,
                        match: match[0],
                        index: match.index,
                        length: match[0].length
                    }));
                    matches.push(...typeMatches);
                }
            });

            // Remove overlapping matches
            matches = matches.filter((match, index) => {
                for (let i = 0; i < matches.length; i++) {
                    if (i !== index) {
                        const other = matches[i];
                        if (match.index < other.index + other.length && 
                            other.index < match.index + match.length) {
                            // Keep the longer match
                            return match.length >= other.length;
                        }
                    }
                }
                return true;
            });

            // Sort matches by index in reverse order
            matches.sort((a, b) => b.index - a.index);

            // Apply replacements
            matches.forEach(({type, match, index}) => {
                const replacement = useDummyData ? 
                    dummyData[`generate${type.charAt(0).toUpperCase() + type.slice(1)}`]() : 
                    `[REDACTED-${type.toUpperCase()}]`;
                processedChunk = processedChunk.slice(0, index) + replacement + processedChunk.slice(index + match.length);
            });

            return processedChunk;
        }

        // Enhanced processText function
        async function processText() {
            try {
                const inputText = document.getElementById('input-text').value;
                if (!inputText) {
                    showError('Please enter or upload some text to process');
                    return;
                }

                // Show loading state
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Process text in chunks
                const processedText = await processInChunks(inputText);
                
                // Update output
                document.getElementById('output-text').value = processedText;
                
                // Update undo/redo buttons
                updateUndoRedoButtons();
                
                // Hide loading state
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show success message
                const mode = document.getElementById('redactionMode').checked ? 'dummy data' : 'redaction';
                showStatus(`Text processed with ${mode} mode`, 'success');
            } catch (error) {
                showError('Error processing text: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Undo/Redo functions
        function undoRedaction() {
            if (undoStack.length > 0) {
                redoStack.push(currentText);
                currentText = undoStack.pop();
                document.getElementById('output-text').value = currentText;
                updateUndoRedoButtons();
            }
        }

        function redoRedaction() {
            if (redoStack.length > 0) {
                undoStack.push(currentText);
                currentText = redoStack.pop();
                document.getElementById('output-text').value = currentText;
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = undoStack.length === 0;
            document.getElementById('redoBtn').disabled = redoStack.length === 0;
        }

        // Copy selected text
        function copySelected() {
            const output = document.getElementById('output-text');
            const selectedText = output.value.substring(output.selectionStart, output.selectionEnd);
            if (selectedText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    alert('Selected text copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy text:', err);
                });
            }
        }

        // Export functions
        function toggleExportOptions() {
            document.getElementById('exportOptions').style.display = 
                document.getElementById('exportOptions').style.display === 'block' ? 'none' : 'block';
        }

        function exportResults(format) {
            const detectedItems = {}; // Collect all detected items
            let content;

            if (format === 'json') {
                content = JSON.stringify(detectedItems, null, 2);
                downloadFile(content, 'detected_items.json', 'application/json');
            } else if (format === 'csv') {
                const csv = Object.entries(detectedItems)
                    .map(([type, items]) => `${type},${items.join(',')}`)
                    .join('\n');
                downloadFile(csv, 'detected_items.csv', 'text/csv');
            }
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Error handling
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            if (!errorMessage) {
                console.error('Error message element not found');
                return;
            }
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.className = 'error-message fade-in';
            errorMessage.style.display = 'block';
            
            // Also log to console for debugging
            console.error('Error:', message);
            
            setTimeout(() => {
                errorMessage.className = 'error-message fade-out';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 500);
            }, 4500);
        }

        function copyToClipboard() {
            const outputText = document.getElementById('output-text');
            outputText.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        function clearInput() {
            document.getElementById('input-text').value = '';
            document.getElementById('output-text').value = '';
            document.getElementById('sensitive-items-list').innerHTML = '';
        }

        function downloadOutput() {
            const outputText = document.getElementById('output-text').value;
            if (outputText) {
                const blob = new Blob([outputText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'redacted_log.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        // Add event listener for redaction mode toggle
        document.getElementById('redactionMode').addEventListener('change', function() {
            const useDummyData = this.checked;
            const inputText = document.getElementById('input-text').value;
            
            if (inputText) {
                // Store current text before processing
                if (undoStack.length === 0) {
                    undoStack.push(inputText);
                }
                
                // Process text with new mode
                processText();
                
                // Show status message
                showStatus(useDummyData ? 'Switched to dummy data mode' : 'Switched to redaction mode', 'info');
            }
        });

        // Add connection status check
        function checkConnection() {
            if (!navigator.onLine) {
                showStatus('You are offline. Some features may not work.', 'warning');
            }
        }

        window.addEventListener('online', () => showStatus('Connection restored', 'success'));
        window.addEventListener('offline', () => showStatus('Connection lost', 'warning'));

        // Initial connection check
        checkConnection();

        // Modal functions
        function openInfoModal() {
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('infoModal')) {
                closeInfoModal();
            }
        }

        // Add function to reset preferences
        function resetPreferences() {
            const checkboxes = document.querySelectorAll('.redaction-type input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            document.getElementById('redactionMode').checked = false;
            savePreferences();
            showStatus('Settings reset to defaults', 'success');
        }
    </script>
</body>
</html>
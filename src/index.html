<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLog Redaction Tool</title>
    <script src="https://unpkg.com/compromise@14.10.0"></script>
    <style>
        /* Basic reset and modern styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 2.5rem;
        }

        .security-info {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .redaction-controls {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .redaction-type {
            margin: 10px 0;
        }

        .detected-items {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }

        .section {
            margin: 20px 0;
        }

        .section-header {
            background-color: #f6f8fa;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-header:hover {
            background-color: #f0f2f5;
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: white;
        }

        .section-content.expanded {
            max-height: 500px;
            overflow: auto;
        }

        .text-area-container {
            padding: 10px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .button-group {
            margin-top: 10px;
        }

        .button-group button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button-group button:hover {
            background-color: #2980b9;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .file-section {
            margin: 2rem 0;
            text-align: center;
        }

        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-label:hover, .file-label:focus {
            background-color: #2980b9;
        }

        .file-info {
            margin-top: 1rem;
            color: #666;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e74c3c;
            margin: 1rem 0;
            padding: 0.5rem;
            background-color: #fde8e8;
            border-radius: 4px;
            display: none;
        }

        .redaction-mode {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
            border: 1px solid #bbdefb;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .mode-label {
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }

        .preview-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
            cursor: help;
        }

        .toolbar {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 5px 10px;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }

        .toolbar button:hover {
            background-color: #dee2e6;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-options {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }

        .export-options a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .export-options a:hover {
            background-color: #f1f1f1;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        .status-message.info {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1976d2;
        }

        .status-message.warning {
            background-color: #fff3e0;
            border: 1px solid #ffe0b2;
            color: #f57c00;
        }

        .status-message.error {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
        }

        .status-message.success {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            color: #2e7d32;
        }

        .sensitive-data {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
            border: 1px solid #ffeeba;
            position: relative;
        }
        .sensitive-data:hover::after {
            content: attr(data-type);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        .info-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }

        .info-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SecureLog Redaction Tool</h1>
        <button class="info-button" onclick="openInfoModal()">How It Works</button>
        <div class="security-info">
            <h3>Security Information</h3>
            <p>This tool helps redact sensitive information from logs before processing. All processing is done locally in your browser.</p>
        </div>

        <!-- File Upload Section -->
        <div class="file-section">
            <label for="logFile" class="file-label" role="button" tabindex="0">
                Choose a log file to process
                <input type="file" id="logFile" accept=".log,.txt" aria-label="Choose a log file to process" style="display: none;">
            </label>
            <div id="fileInfo" class="file-info" aria-live="polite"></div>
            <div id="statusMessage" class="status-message" style="display: none;"></div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>

        <div class="redaction-controls">
            <h3>Redaction Settings</h3>
            <div class="redaction-type">
                <label>
                    <input type="checkbox" id="redactIP" checked>
                    IP Addresses (IPv4 & IPv6)
                </label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactIpv4" checked>
                <label for="redactIpv4">IPv4 Addresses</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactIpv6" checked>
                <label for="redactIpv6">IPv6 Addresses</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactDomain" checked>
                <label for="redactDomain">Domain Names & Hostnames</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactSid" checked>
                <label for="redactSid">Security IDs (SIDs)</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactAccount" checked>
                <label for="redactAccount">Account Names</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactGuid" checked>
                <label for="redactGuid">GUIDs & Unique Identifiers</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactKerberos" checked>
                <label for="redactKerberos">Kerberos Tickets</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactMac" checked>
                <label for="redactMac">MAC Addresses</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactCloudCreds" checked>
                <label for="redactCloudCreds">Cloud Credentials</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactJwt" checked>
                <label for="redactJwt">JWT Tokens</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactBase64" checked>
                <label for="redactBase64">Base64 Encoded Data</label>
            </div>
            <div class="redaction-type">
                <input type="checkbox" id="redactEmail" checked>
                <label for="redactEmail">Email Addresses</label>
            </div>
        </div>

        <div class="redaction-mode">
            <h4>Redaction Mode</h4>
            <div class="mode-label">Redacted Text</div>
            <label class="toggle-switch">
                <input type="checkbox" id="redactionMode">
                <span class="slider"></span>
            </label>
            <div class="mode-label">Dummy Data</div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                Toggle between [REDACTED] placeholders and realistic-looking dummy data
            </div>
        </div>

        <div class="toolbar">
            <button onclick="undoRedaction()" id="undoBtn" disabled>Undo</button>
            <button onclick="redoRedaction()" id="redoBtn" disabled>Redo</button>
            <button onclick="copySelected()">Copy Selected</button>
            <div class="export-dropdown">
                <button onclick="toggleExportOptions()">Export Results</button>
                <div class="export-options" id="exportOptions">
                    <a href="#" onclick="exportResults('json')">Export as JSON</a>
                    <a href="#" onclick="exportResults('csv')">Export as CSV</a>
                </div>
            </div>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>

        <div class="section">
            <div class="section-header" onclick="toggleSection('input')">
                <h2>Input Log Data</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content" id="input-section">
                <div class="text-area-container">
                    <textarea id="input-text" placeholder="Paste your log data here..."></textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header" onclick="toggleSection('output')">
                <h2>Processed Output</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="section-content" id="output-section">
                <div class="detected-items" id="detected-sensitive-info">
                    <h4>Detected Sensitive Information:</h4>
                    <ul id="sensitive-items-list"></ul>
                </div>
                <div class="text-area-container">
                    <textarea id="output-text" readonly></textarea>
                    <div class="button-group">
                        <button onclick="downloadOutput()">Download Redacted Log</button>
                        <button onclick="copyToClipboard()">Copy to Clipboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Information Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeInfoModal()">&times;</span>
            <h2>How SecureLog Redactor Works</h2>
            <div class="modal-body">
                <h3>Privacy & Security</h3>
                <ul>
                    <li><strong>100% Local Processing:</strong> All data processing occurs entirely in your browser. No data is ever sent to external servers.</li>
                    <li><strong>Zero Data Storage:</strong> We don't store any of your data. Once you close the browser tab, all data is cleared.</li>
                    <li><strong>Offline Capable:</strong> The tool works even without an internet connection after initial load.</li>
                </ul>
                
                <h3>Technical Details</h3>
                <ul>
                    <li><strong>Browser-Based:</strong> Uses modern browser technologies for secure, local processing.</li>
                    <li><strong>Pattern Recognition:</strong> Advanced algorithms identify sensitive data patterns.</li>
                    <li><strong>Real-time Processing:</strong> Instant redaction as you type or upload files.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner" role="progressbar" aria-label="Processing file"></div>
        <p>Processing...</p>
    </div>

    <script>
        // Configuration constants
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            CHUNK_SIZE: 50000, // 50KB chunks
            ALLOWED_EXTENSIONS: ['.log', '.txt']
        };

        // File validation
        function validateFile(file) {
            if (!file) {
                throw new Error('Please select a file');
            }

            if (file.size > CONFIG.MAX_FILE_SIZE) {
                throw new Error('File size exceeds 10MB limit');
            }

            const extension = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            if (!CONFIG.ALLOWED_EXTENSIONS.includes(extension)) {
                throw new Error('Invalid file type. Please upload .log or .txt files only');
            }
        }

        // Show error message
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Error handling and status functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            console.log(`Status [${type}]:`, message);
        }

        function showError(error) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = error.message || 'An error occurred';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        }

        // File handling
        document.getElementById('logFile').addEventListener('change', async function(event) {
            try {
                const file = event.target.files[0];
                if (!file) {
                    throw new Error('No file selected');
                }
                showStatus('Processing file: ' + file.name);
                const fileInfo = document.getElementById('fileInfo');
                const loadingOverlay = document.getElementById('loadingOverlay');
                const errorMessage = document.getElementById('errorMessage');
                
                errorMessage.style.display = 'none';
                fileInfo.textContent = '';

                validateFile(file);
                loadingOverlay.style.display = 'flex';
                fileInfo.textContent = `Processing ${file.name}...`;

                const reader = new FileReader();

                reader.onload = async function(e) {
                    try {
                        const log = e.target.result;
                        document.getElementById('input-text').value = log;
                        processText();
                        fileInfo.textContent = `Successfully processed ${file.name}`;
                        
                        // Expand the output section
                        document.getElementById('output-section').classList.add('expanded');
                    } catch (error) {
                        showError(error);
                    } finally {
                        loadingOverlay.style.display = 'none';
                    }
                };

                reader.onerror = function() {
                    showError('Error reading file');
                    loadingOverlay.style.display = 'none';
                };

                reader.readAsText(file);
            } catch (error) {
                showError(error);
            }
        });

        // Keyboard accessibility for file input label
        document.querySelector('.file-label').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });

        function toggleSection(sectionId) {
            const section = document.getElementById(`${sectionId}-section`);
            section.classList.toggle('expanded');
        }

        // Dummy data generators
        const dummyData = {
            generateIP: () => {
                const ip = Array.from({length: 4}, () => Math.floor(Math.random() * 256)).join('.');
                return `192.168.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
            },
            generateIPv6: () => {
                return Array.from({length: 8}, () => 
                    Math.floor(Math.random() * 65536).toString(16).padStart(4, '0')
                ).join(':');
            },
            generateDomain: () => {
                const domains = ['example.com', 'test.local', 'internal.net', 'dev.org'];
                const prefixes = ['srv', 'host', 'web', 'db', 'app'];
                const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
                const domain = domains[Math.floor(Math.random() * domains.length)];
                return `${prefix}-${Math.floor(Math.random() * 999)}.${domain}`;
            },
            generatePath: () => {
                const paths = ['/var/log', '/etc', '/usr/local', 'C:\\Program Files', 'D:\\Data'];
                const files = ['config.xml', 'data.db', 'app.log', 'system.dat'];
                const path = paths[Math.floor(Math.random() * paths.length)];
                const file = files[Math.floor(Math.random() * files.length)];
                return `${path}\\${file}`;
            },
            generateSID: () => {
                const parts = Array.from({length: 6}, () => Math.floor(Math.random() * 100000));
                return `S-1-5-21-${parts.join('-')}`;
            },
            generateGUID: () => {
                const hex = () => Math.floor(Math.random() * 16).toString(16);
                const block = (len) => Array.from({length: len}, hex).join('');
                return `${block(8)}-${block(4)}-${block(4)}-${block(4)}-${block(12)}`;
            },
            generateKerberos: () => {
                const services = ['HTTP', 'MSSQL', 'LDAP'];
                const service = services[Math.floor(Math.random() * services.length)];
                return `krbtgt/${service}@EXAMPLE.COM`;
            },
            generateMAC: () => {
                const mac = Array.from({length: 6}, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join(':');
                return mac;
            },
            generateCloudCreds: () => {
                const providers = ['AWS', 'Azure', 'GCP'];
                const provider = providers[Math.floor(Math.random() * providers.length)];
                return `${provider} Access Key ID: ${Math.floor(Math.random() * 1000000000)}`;
            },
            generateJWT: () => {
                const header = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9';
                const payload = 'eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaGFuIjoiMjMwfQ';
                const signature = 'SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
                return `${header}.${payload}.${signature}`;
            },
            generateBase64: () => {
                const base64 = 'VGhlIHF1aWNrIGJyb3duIGZveA==';
                return base64;
            },
            generateEmail: () => {
                const domains = ['example.com', 'test.local', 'internal.net', 'dev.org'];
                const localParts = ['john', 'jane', 'admin', 'user'];
                const domain = domains[Math.floor(Math.random() * domains.length)];
                const localPart = localParts[Math.floor(Math.random() * localParts.length)];
                return `${localPart}@${domain}`;
            }
        };

        // Cache for compiled regex patterns
        const REGEX_PATTERNS = {
            ipv4: /\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,
            ipv6: /\b(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}\b|::1\b/gi,
            domain: /\b(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+(?:local|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/gi,
            sid: /\bS-1-[0-9-]+\b/g,
            guid: /\{?[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}\}?/gi,
            email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g
        };

        // Function to check if a string is a path
        function isPath(str) {
            return (
                str.includes(':\\') || // Windows path
                str.startsWith('/') || // Unix path
                str.startsWith('\\\\') || // Network share
                /\\[^\\\/\s]+/.test(str) // Path component
            );
        }

        // Undo/Redo stacks
        const undoStack = [];
        const redoStack = [];
        let currentText = '';

        // Load saved preferences
        function loadPreferences() {
            try {
                const savedPrefs = localStorage.getItem('redactionPreferences');
                if (savedPrefs) {
                    const prefs = JSON.parse(savedPrefs);
                    Object.entries(prefs).forEach(([id, checked]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.checked = checked;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        // Save preferences
        function savePreferences() {
            const prefs = {};
            document.querySelectorAll('.redaction-type input[type="checkbox"]').forEach(checkbox => {
                prefs[checkbox.id] = checkbox.checked;
            });
            localStorage.setItem('redactionPreferences', JSON.stringify(prefs));
        }

        // Initialize preferences
        loadPreferences();
        document.querySelectorAll('.redaction-type input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', savePreferences);
        });

        // Initialize redaction options
        const redactionTypes = {
            'Ipv4': true,
            'Ipv6': true,
            'Domain': true,
            'Sid': true,
            'Account': true,
            'Guid': true,
            'Kerberos': true,
            'Mac': true,
            'CloudCreds': true,
            'Jwt': true,
            'Base64': true,
            'Email': true
        };

        // Set initial checkbox states
        Object.keys(redactionTypes).forEach(type => {
            const checkbox = document.getElementById(`redact${type}`);
            if (checkbox) {
                checkbox.checked = redactionTypes[type];
            }
        });

        // Chunked processing
        async function processInChunks(text, chunkSize = 50000) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.slice(i, i + chunkSize));
            }

            const progressBar = document.getElementById('progressBar');
            const progressBarFill = document.getElementById('progressBarFill');
            progressBar.style.display = 'block';

            let processedText = '';
            for (let i = 0; i < chunks.length; i++) {
                const chunk = chunks[i];
                // Process chunk
                processedText += await processChunk(chunk);
                // Update progress
                const progress = ((i + 1) / chunks.length) * 100;
                progressBarFill.style.width = `${progress}%`;
                // Allow UI to update
                await new Promise(resolve => setTimeout(resolve, 0));
            }

            progressBar.style.display = 'none';
            return processedText;
        }

        async function processChunk(chunk) {
            const useDummyData = document.getElementById('redactionMode').checked;

            try {
                // Try to parse as JSON first
                const isJson = chunk.trim().startsWith('{') && chunk.trim().endsWith('}');
                if (isJson) {
                    const jsonObj = JSON.parse(chunk);
                    
                    // Process each field in the JSON object
                    const processJsonValue = (value) => {
                        if (typeof value === 'string') {
                            let processedValue = value;
                            let matches = [];
                            
                            // First collect all matches
                            Object.entries(REGEX_PATTERNS).forEach(([type, regex]) => {
                                const checkbox = document.getElementById(`redact${type.charAt(0).toUpperCase() + type.slice(1)}`);
                                if (checkbox && checkbox.checked) {
                                    const typeMatches = [...processedValue.matchAll(regex)].map(match => ({
                                        type,
                                        match: match[0],
                                        index: match.index,
                                        length: match[0].length
                                    }));
                                    matches.push(...typeMatches);
                                }
                            });

                            // Remove overlapping matches
                            matches = matches.filter((match, index) => {
                                for (let i = 0; i < matches.length; i++) {
                                    if (i !== index) {
                                        const other = matches[i];
                                        if (match.index < other.index + other.length && 
                                            other.index < match.index + match.length) {
                                            // Keep the longer match
                                            return match.length >= other.length;
                                        }
                                    }
                                }
                                return true;
                            });

                            // Sort matches by index in reverse order
                            matches.sort((a, b) => b.index - a.index);

                            // Apply replacements
                            matches.forEach(({type, match, index}) => {
                                const replacement = useDummyData ? 
                                    dummyData[`generate${type.charAt(0).toUpperCase() + type.slice(1)}`]() : 
                                    `[REDACTED-${type.toUpperCase()}]`;
                                processedValue = processedValue.slice(0, index) + replacement + processedValue.slice(index + match.length);
                            });

                            return processedValue;
                        } else if (Array.isArray(value)) {
                            return value.map(item => processJsonValue(item));
                        } else if (typeof value === 'object' && value !== null) {
                            const processed = {};
                            Object.entries(value).forEach(([k, v]) => {
                                processed[k] = processJsonValue(v);
                            });
                            return processed;
                        }
                        return value;
                    };

                    const processedJson = processJsonValue(jsonObj);
                    return JSON.stringify(processedJson, null, 2);
                }
            } catch (e) {
                console.log('Not valid JSON, processing as plain text:', e);
            }

            // Process as plain text if not JSON
            let processedChunk = chunk;
            let matches = [];
            
            // First collect all matches
            Object.entries(REGEX_PATTERNS).forEach(([type, regex]) => {
                const checkbox = document.getElementById(`redact${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (checkbox && checkbox.checked) {
                    const typeMatches = [...processedChunk.matchAll(regex)].map(match => ({
                        type,
                        match: match[0],
                        index: match.index,
                        length: match[0].length
                    }));
                    matches.push(...typeMatches);
                }
            });

            // Remove overlapping matches
            matches = matches.filter((match, index) => {
                for (let i = 0; i < matches.length; i++) {
                    if (i !== index) {
                        const other = matches[i];
                        if (match.index < other.index + other.length && 
                            other.index < match.index + match.length) {
                            // Keep the longer match
                            return match.length >= other.length;
                        }
                    }
                }
                return true;
            });

            // Sort matches by index in reverse order
            matches.sort((a, b) => b.index - a.index);

            // Apply replacements
            matches.forEach(({type, match, index}) => {
                const replacement = useDummyData ? 
                    dummyData[`generate${type.charAt(0).toUpperCase() + type.slice(1)}`]() : 
                    `[REDACTED-${type.toUpperCase()}]`;
                processedChunk = processedChunk.slice(0, index) + replacement + processedChunk.slice(index + match.length);
            });

            return processedChunk;
        }

        // Enhanced processText function
        async function processText() {
            const input = document.getElementById('input-text').value;
            
            // Input validation
            if (input.length > 10000000) { // 10MB limit
                showError('Input text is too large. Please reduce the size.');
                return;
            }

            // Save for undo
            undoStack.push(currentText);
            redoStack.length = 0;
            
            const processedText = await processInChunks(input);
            currentText = processedText;
            
            document.getElementById('output-text').value = processedText;
            updateUndoRedoButtons();
        }

        // Undo/Redo functions
        function undoRedaction() {
            if (undoStack.length > 0) {
                redoStack.push(currentText);
                currentText = undoStack.pop();
                document.getElementById('output-text').value = currentText;
                updateUndoRedoButtons();
            }
        }

        function redoRedaction() {
            if (redoStack.length > 0) {
                undoStack.push(currentText);
                currentText = redoStack.pop();
                document.getElementById('output-text').value = currentText;
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = undoStack.length === 0;
            document.getElementById('redoBtn').disabled = redoStack.length === 0;
        }

        // Copy selected text
        function copySelected() {
            const output = document.getElementById('output-text');
            const selectedText = output.value.substring(output.selectionStart, output.selectionEnd);
            if (selectedText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    alert('Selected text copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy text:', err);
                });
            }
        }

        // Export functions
        function toggleExportOptions() {
            document.getElementById('exportOptions').style.display = 
                document.getElementById('exportOptions').style.display === 'block' ? 'none' : 'block';
        }

        function exportResults(format) {
            const detectedItems = {}; // Collect all detected items
            let content;

            if (format === 'json') {
                content = JSON.stringify(detectedItems, null, 2);
                downloadFile(content, 'detected_items.json', 'application/json');
            } else if (format === 'csv') {
                const csv = Object.entries(detectedItems)
                    .map(([type, items]) => `${type},${items.join(',')}`)
                    .join('\n');
                downloadFile(csv, 'detected_items.csv', 'text/csv');
            }
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Error handling
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function copyToClipboard() {
            const outputText = document.getElementById('output-text');
            outputText.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        function clearInput() {
            document.getElementById('input-text').value = '';
            document.getElementById('output-text').value = '';
            document.getElementById('sensitive-items-list').innerHTML = '';
        }

        function downloadOutput() {
            const outputText = document.getElementById('output-text').value;
            if (outputText) {
                const blob = new Blob([outputText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'redacted_log.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        // Add event listener for redaction mode toggle
        document.getElementById('redactionMode').addEventListener('change', function() {
            if (document.getElementById('input-text').value) {
                processText();
            }
        });

        // Add connection status check
        function checkConnection() {
            if (!navigator.onLine) {
                showStatus('You are offline. Some features may not work.', 'warning');
            }
        }

        window.addEventListener('online', () => showStatus('Connection restored', 'success'));
        window.addEventListener('offline', () => showStatus('Connection lost', 'warning'));

        // Initial connection check
        checkConnection();

        // Modal functions
        function openInfoModal() {
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('infoModal')) {
                closeInfoModal();
            }
        }
    </script>
</body>
</html>